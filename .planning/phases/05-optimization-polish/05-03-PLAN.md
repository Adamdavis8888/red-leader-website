---
phase: 05-optimization-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/layout.tsx
  - .env.local.example
autonomous: true
user_setup:
  - service: plausible
    why: "Privacy-focused analytics"
    env_vars:
      - name: NEXT_PUBLIC_PLAUSIBLE_DOMAIN
        source: "Your domain registered in Plausible (e.g., redleader.io)"
      - name: NEXT_PUBLIC_PLAUSIBLE_HOST
        source: "Plausible Cloud: plausible.io, or your self-hosted URL"
    dashboard_config:
      - task: "Create site in Plausible"
        location: "https://plausible.io/sites/new"

must_haves:
  truths:
    - "Page views are tracked across all pages"
    - "Analytics script loads only in production"
    - "No cookies set (privacy-focused)"
    - "Analytics dashboard shows visitor data"
  artifacts:
    - path: "app/layout.tsx"
      provides: "Plausible script integration"
      contains: "plausible"
    - path: ".env.local.example"
      provides: "Environment variable documentation"
      contains: "PLAUSIBLE"
  key_links:
    - from: "app/layout.tsx"
      to: "plausible.io"
      via: "script src"
      pattern: "plausible"
---

<objective>
Integrate Plausible Analytics for privacy-focused visitor tracking.

Purpose: Track visitor behavior and page performance without cookies or invasive tracking, complying with GDPR without cookie banners.

Output: Plausible script in root layout, environment configuration for domain/host.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Root layout for script injection:
@app/layout.tsx

Environment configuration:
@.env.local.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Plausible Analytics script to root layout</name>
  <files>
    app/layout.tsx
  </files>
  <action>
Integrate Plausible Analytics using Next.js Script component:

**app/layout.tsx modifications:**

1. Import Script from 'next/script' at top of file

2. Add environment variable reads:
```typescript
const plausibleDomain = process.env.NEXT_PUBLIC_PLAUSIBLE_DOMAIN
const plausibleHost = process.env.NEXT_PUBLIC_PLAUSIBLE_HOST || 'plausible.io'
```

3. Add Plausible script in the head section of html tag (before body):
- Only render if plausibleDomain is set (conditional rendering)
- Use Script component with strategy="afterInteractive"
- data-domain attribute set to plausibleDomain
- src set to `https://${plausibleHost}/js/script.js`
- defer attribute for non-blocking load

Pattern:
```typescript
{plausibleDomain && (
  <Script
    strategy="afterInteractive"
    data-domain={plausibleDomain}
    src={`https://${plausibleHost}/js/script.js`}
  />
)}
```

4. Keep existing metadata, Inter font setup, and body content unchanged

Benefits of this approach:
- Script only loads when NEXT_PUBLIC_PLAUSIBLE_DOMAIN is set
- Works with Plausible Cloud or self-hosted instances
- afterInteractive strategy doesn't block page render
- No cookies set by Plausible (GDPR compliant)
  </action>
  <verify>
Run `npm run dev` and check browser DevTools Network tab:
- Without env var: No Plausible script loaded
- With env var set: Script loads from configured host
- Check console for no errors

After setting NEXT_PUBLIC_PLAUSIBLE_DOMAIN and NEXT_PUBLIC_PLAUSIBLE_HOST:
View page source and confirm script tag present with correct domain.
  </verify>
  <done>
Plausible script conditionally renders based on env var.
Script uses correct domain and host configuration.
No impact on page load when analytics disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document environment variables for Plausible</name>
  <files>
    .env.local.example
  </files>
  <action>
Update .env.local.example with Plausible configuration:

Add these variables with documentation comments:

```
# Plausible Analytics
# Sign up at https://plausible.io or self-host
# NEXT_PUBLIC_PLAUSIBLE_DOMAIN - Your site domain (e.g., redleader.io)
# NEXT_PUBLIC_PLAUSIBLE_HOST - Analytics host (default: plausible.io)
NEXT_PUBLIC_PLAUSIBLE_DOMAIN=
NEXT_PUBLIC_PLAUSIBLE_HOST=plausible.io
```

Keep existing variables in the file (Calendly, phone, etc).

This allows:
- Easy setup for new developers
- Clear documentation of required vs optional vars
- Self-hosted Plausible support via custom host
  </action>
  <verify>
Read .env.local.example and confirm:
- Plausible variables documented
- Comments explain each variable's purpose
- Default host value provided
  </verify>
  <done>
Environment variables documented for easy setup.
Both cloud and self-hosted options supported.
Existing env vars preserved.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. Without env vars: Site loads normally, no analytics script
3. With env vars set: Script tag appears in page source
4. Script has correct data-domain attribute
5. No console errors related to Plausible
6. .env.local.example contains Plausible documentation
</verification>

<success_criteria>
1. Plausible script loads from configured host
2. Script only renders when NEXT_PUBLIC_PLAUSIBLE_DOMAIN is set
3. Environment variables documented in .env.local.example
4. Both Plausible Cloud and self-hosted supported
5. No cookies set (verify in DevTools Application tab)
6. Page load performance not impacted (afterInteractive strategy)
</success_criteria>

<output>
After completion, create `.planning/phases/05-optimization-polish/05-03-SUMMARY.md`
</output>
